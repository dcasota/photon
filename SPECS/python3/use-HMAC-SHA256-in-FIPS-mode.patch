From e0ffcc15655e67e2241e0a05ef117117cd142491 Mon Sep 17 00:00:00 2001
From: Prashant S Chauhan <psinghchauha@vmware.com>
Date: Fri, 25 Aug 2023 08:26:32 +0000
Subject: [PATCH] multiprocessing library use HMAC-SHA256  in FIPS mode

---
 Lib/multiprocessing/connection.py | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/Lib/multiprocessing/connection.py b/Lib/multiprocessing/connection.py
index 8e2facf92a..4dd3ddbd63 100644
--- a/Lib/multiprocessing/connection.py
+++ b/Lib/multiprocessing/connection.py
@@ -736,7 +736,11 @@ def deliver_challenge(connection, authkey):
             "Authkey must be bytes, not {0!s}".format(type(authkey)))
     message = os.urandom(MESSAGE_LENGTH)
     connection.send_bytes(CHALLENGE + message)
-    digest = hmac.new(authkey, message, 'md5').digest()
+    try:
+        digest = hmac.new(authkey, message, 'md5').digest()
+    except ValueError:
+        # If FIPS mode i.e MD5 is not supported use SHA-256 protocol
+        digest = hmac.new(authkey, message, 'sha256').digest()
     response = connection.recv_bytes(256)        # reject large message
     if response == digest:
         connection.send_bytes(WELCOME)
@@ -752,7 +756,11 @@ def answer_challenge(connection, authkey):
     message = connection.recv_bytes(256)         # reject large message
     assert message[:len(CHALLENGE)] == CHALLENGE, 'message = %r' % message
     message = message[len(CHALLENGE):]
-    digest = hmac.new(authkey, message, 'md5').digest()
+    try:
+        digest = hmac.new(authkey, message, 'md5').digest()
+    except ValueError:
+        # If FIPS mode i.e MD5 is not supported use SHA-256 protocol
+        digest = hmac.new(authkey, message, 'sha256').digest()
     connection.send_bytes(digest)
     response = connection.recv_bytes(256)        # reject large message
     if response != WELCOME:
-- 
2.35.6

