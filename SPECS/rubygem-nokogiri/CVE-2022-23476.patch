From 9fe0761c47c0d4270d1a5220cfd25de080350d50 Mon Sep 17 00:00:00 2001
From: Mike Dalessio <mike.dalessio@gmail.com>
Date: Tue, 6 Dec 2022 01:51:37 -0500
Subject: [PATCH] fix(cruby): XML::Reader#attribute_hash returns nil on error

Note that on JRuby, the namespaces are still returned because the
parse error would raised on the subsequent node expansion.

This restores the behavior from v1.13.7

[Backported to nokogiri-1.13.9 https://github.com/sparklemotion/nokogiri/commit/9fe0761c47c0d4270d1a5220cfd25de080350d50]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
---
 ext/nokogiri/xml_reader.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/ext/nokogiri/xml_reader.c b/ext/nokogiri/xml_reader.c
index 022f8ff..0895ea6 100644
--- a/ext/nokogiri/xml_reader.c
+++ b/ext/nokogiri/xml_reader.c
@@ -212,6 +212,10 @@ rb_xml_reader_attribute_hash(VALUE rb_reader)
   }
 
   c_node = xmlTextReaderExpand(c_reader);
+  if (c_node == NULL) {
+    return Qnil;
+  }
+
   c_property = c_node->properties;
   while (c_property != NULL) {
     VALUE rb_name = NOKOGIRI_STR_NEW2(c_property->name);
-- 
2.39.4

