From 60d8663afb0fb7f113604404c50840dfe9320039 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Tue, 8 Oct 2024 11:20:40 +0200
Subject: [PATCH] hsts: avoid the local buffer and memcpy on lookup

commit 60d8663afb0fb7f113604404c50840dfe9320039 upstream.

Closes #15190

[tapas: Backported the change to 8.1.2]
    
Signed-off-by: Tapas Kundu <tapas.kundu@broadcom.com>

diff --git a/lib/hsts.c b/lib/hsts.c
index 53c01fc52..a3537b7f2 100644
--- a/lib/hsts.c
+++ b/lib/hsts.c
@@ -249,7 +249,6 @@ struct stsentry *Curl_hsts(struct hsts *h, const char *hostname,
                            bool subdomain)
 {
   if(h) {
-    char buffer[MAX_HSTS_HOSTLEN + 1];
     time_t now = time(NULL);
     size_t hlen = strlen(hostname);
     struct Curl_llist_element *e;
@@ -257,15 +256,13 @@ struct stsentry *Curl_hsts(struct hsts *h, const char *hostname,
 
     if((hlen > MAX_HSTS_HOSTLEN) || !hlen)
       return NULL;
-    memcpy(buffer, hostname, hlen);
     if(hostname[hlen-1] == '.')
       /* remove the trailing dot */
       --hlen;
-    buffer[hlen] = 0;
-    hostname = buffer;
 
     for(e = h->list.head; e; e = n) {
       struct stsentry *sts = e->ptr;
+      size_t ntail;
       n = e->next;
       if(sts->expires <= now) {
         /* remove expired entries */
@@ -273,16 +270,15 @@ struct stsentry *Curl_hsts(struct hsts *h, const char *hostname,
         hsts_free(sts);
         continue;
       }
-      if(subdomain && sts->includeSubDomains) {
-        size_t ntail = strlen(sts->host);
-        if(ntail < hlen) {
+      ntail = strlen(sts->host);
+      if((subdomain && sts->includeSubDomains) && (ntail < hlen)) {
           size_t offs = hlen - ntail;
           if((hostname[offs-1] == '.') &&
              strncasecompare(&hostname[offs], sts->host, ntail))
             return sts;
-        }
       }
-      if(strcasecompare(hostname, sts->host))
+      /* avoid strcasecompare because the host name is not null terminated */
+      if((hlen == ntail) && strncasecompare(hostname, sts->host, hlen))
         return sts;
     }
   }
