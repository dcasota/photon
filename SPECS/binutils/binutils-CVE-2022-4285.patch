From 5c831a3c7f3ca98d6aba1200353311e1a1f84c70 Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Wed, 19 Oct 2022 15:09:12 +0100
Subject: [PATCH] Fix an illegal memory access when parsing an ELF file
 containing corrupt symbol version information.

        PR 29699
        * elf.c (_bfd_elf_slurp_version_tables): Fail if the sh_info field
        of the section header is zero.

[bguruswamy: Original changes to bfd/ChangeLog are relocated for
patching to pass, rest of the original changes are kept as it is]

Signed-off-by: Guruswamy Basavaiah <bguruswamy@vmware.com>
---
 bfd/ChangeLog | 5 +++++
 bfd/elf.c     | 4 +++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/bfd/ChangeLog b/bfd/ChangeLog
index 1bd87531..e59ede55 100644
--- a/bfd/ChangeLog
+++ b/bfd/ChangeLog
@@ -1,3 +1,8 @@
+2022-10-19  Nick Clifton  <nickc@redhat.com>
+
+	PR 29699
+	* elf.c (_bfd_elf_slurp_version_tables): Fail if the sh_info field
+	of the section header is zero.
 2023-03-30  Nick Clifton  <nickc@redhat.com>
 
 	PR 30285
diff --git a/bfd/elf.c b/bfd/elf.c
index e0291181..4ae4977c 100644
--- a/bfd/elf.c
+++ b/bfd/elf.c
@@ -8868,7 +8868,9 @@ _bfd_elf_slurp_version_tables (bfd *abfd, bool default_imported_symver)
 	  bfd_set_error (bfd_error_file_too_big);
 	  goto error_return_verref;
 	}
-      elf_tdata (abfd)->verref = (Elf_Internal_Verneed *) bfd_alloc (abfd, amt);
+      if (amt == 0)
+	goto error_return_verref;
+      elf_tdata (abfd)->verref = (Elf_Internal_Verneed *) bfd_zalloc (abfd, amt);
       if (elf_tdata (abfd)->verref == NULL)
 	goto error_return_verref;
 
-- 
2.25.1

