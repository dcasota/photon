From b027015e5b5aa35dd7957cb6f7a9561fc2f552c4 Mon Sep 17 00:00:00 2001
From: Demi Marie Obenour <demi@invisiblethingslab.com>
Date: Thu, 6 May 2021 20:03:10 -0400
Subject: [PATCH 09/13] verifySignature(): package signatures must be
 PGPSIGTYPE_BINARY

RPM packages are binary documents and must be signed as such.  To avoid
having to access the fields of pgpDigParams() directly, this adds a new
accessor function, pgpSignatureType().  pgpSignatureType() returns the
type of a signature, or -1 if the PGP data is NULL or is not a
signature.

Prior to commit b5e8bc74b2b05aa557f663fe227b94d2bc64fbd8 this was kind
of checked inside the parser but incorrectly.
---
 lib/rpmvs.c    |  4 +++-
 rpmio/rpmpgp.c | 10 ++++++++++
 rpmio/rpmpgp.h |  9 +++++++++
 3 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/lib/rpmvs.c b/lib/rpmvs.c
index d2f4f31..88f2b20 100644
--- a/lib/rpmvs.c
+++ b/lib/rpmvs.c
@@ -574,7 +574,9 @@ exit:
 static rpmRC
 verifySignature(rpmKeyring keyring, struct rpmsinfo_s *sinfo)
 {
-    rpmRC res = rpmKeyringVerifySig(keyring, sinfo->sig, sinfo->ctx);
+    rpmRC res = RPMRC_FAIL;
+    if (pgpSignatureType(sinfo->sig) == PGPSIGTYPE_BINARY)
+	res = rpmKeyringVerifySig(keyring, sinfo->sig, sinfo->ctx);
 
     return res;
 }
diff --git a/rpmio/rpmpgp.c b/rpmio/rpmpgp.c
index 3372d57..0c428e8 100644
--- a/rpmio/rpmpgp.c
+++ b/rpmio/rpmpgp.c
@@ -410,6 +410,16 @@ static int pgpVersion(const uint8_t *h, size_t hlen, uint8_t *version)
     return 0;
 }
 
+int pgpSignatureType(pgpDigParams _digp)
+{
+    int rc = -1;
+
+    if (_digp && _digp->tag == PGPTAG_SIGNATURE)
+	rc = _digp->sigtype;
+
+    return rc;
+}
+
 static int pgpPrtSubType(const uint8_t *h, size_t hlen, pgpSigType sigtype, 
 			 pgpDigParams _digp)
 {
diff --git a/rpmio/rpmpgp.h b/rpmio/rpmpgp.h
index 469b5b3..94f970c 100644
--- a/rpmio/rpmpgp.h
+++ b/rpmio/rpmpgp.h
@@ -1160,6 +1160,15 @@ rpmRC pgpVerifySignature(pgpDigParams key, pgpDigParams sig, DIGEST_CTX hashctx)
  */
 rpmRC pgpVerifySig(pgpDig dig, DIGEST_CTX hashctx);
 
+/** \ingroup rpmpgp
+ * Return the type of a PGP signature. If `sig` is NULL, or is not a signature,
+ * returns -1.
+ *
+ * @param sig		signature
+ * @return 		type of the signature
+ */
+int pgpSignatureType(pgpDigParams sig);
+
 /** \ingroup rpmpgp
  * Return a string identification of a PGP signature/pubkey.
  * @param digp		signature/pubkey container
-- 
2.34.1

