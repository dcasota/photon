From 490a263ffd01a7e830e8c795b72e5052e34fe486 Mon Sep 17 00:00:00 2001
From: Alexey Makhalov <amakhalov@vmware.com>
Date: Tue, 9 May 2017 12:41:17 -0700
Subject: [PATCH] vmware only

Signed-off-by: Bo Gan <ganb@vmware.com>
---
 arch/x86/kernel/cpu/Makefile | 5 +++++
 arch/x86/kernel/cpu/common.c | 3 +++
 arch/x86/kernel/cpu/vmware.c | 5 +++++
 3 files changed, 13 insertions(+)

diff --git a/arch/x86/kernel/cpu/Makefile b/arch/x86/kernel/cpu/Makefile
index 82149a98a..bcf3dadce 100644
--- a/arch/x86/kernel/cpu/Makefile
+++ b/arch/x86/kernel/cpu/Makefile
@@ -19,7 +19,12 @@ KCSAN_SANITIZE_common.o := n
 
 obj-y			:= cacheinfo.o scattered.o topology.o
 obj-y			+= common.o
+
+# Trust rdrand on VMware platform
+ifndef CONFIG_HYPERVISOR_GUEST
 obj-y			+= rdrand.o
+endif
+
 obj-y			+= match.o
 obj-y			+= bugs.o
 obj-y			+= aperfmperf.o
diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.c
index 340dd6cc1..228e48ddb 100644
--- a/arch/x86/kernel/cpu/common.c
+++ b/arch/x86/kernel/cpu/common.c
@@ -1956,7 +1956,10 @@ static void identify_cpu(struct cpuinfo_x86 *c)
 	detect_ht(c);
 #endif
 
+	/* Trust rdrand on VMware platform */
+#ifndef CONFIG_HYPERVISOR_GUEST
 	x86_init_rdrand(c);
+#endif
 	setup_pku(c);
 	setup_cet(c);
 
diff --git a/arch/x86/kernel/cpu/vmware.c b/arch/x86/kernel/cpu/vmware.c
index cd1068e2a..95ea20eb5 100644
--- a/arch/x86/kernel/cpu/vmware.c
+++ b/arch/x86/kernel/cpu/vmware.c
@@ -30,6 +30,7 @@
 #include <linux/static_call.h>
 #include <linux/kmsg_dump.h>
 #include <linux/objtool.h>
+#include <asm/pci_x86.h>
 #include <asm/div64.h>
 #include <asm/x86_init.h>
 #include <asm/hypervisor.h>
@@ -453,6 +454,10 @@ static void __init vmware_platform_setup(void)
 	vmware_set_capabilities();
 
 	kmsg_dump_register(&kmsg_dumper);
+#ifdef CONFIG_PCI
+	/* PCI BIOS service won't work from a PV guest. */
+	pci_probe &= ~PCI_PROBE_BIOS;
+#endif
 }
 
 static u8 __init vmware_select_hypercall(void)
-- 
2.35.6

