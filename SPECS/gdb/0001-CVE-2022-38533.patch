From ef186fe54aa6d281a3ff8a9528417e5cc614c797 Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Sat, 13 Aug 2022 15:32:47 +0930
Subject: [PATCH] PR29482 - strip: heap-buffer-overflow

	PR 29482
	* coffcode.h (coff_set_section_contents): Sanity check _LIB.

[anmolja: resolved hunk failures caused by line numbers]
Signed-off-by: Anmol Jain <anmolja@vmware.com>

---
 bfd/coffcode.h | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/bfd/coffcode.h b/bfd/coffcode.h
index 4b934b9..18b8fec 100644
--- a/bfd/coffcode.h
+++ b/bfd/coffcode.h
@@ -4186,10 +4186,13 @@ coff_set_section_contents (bfd * abfd,
 
 	rec = (bfd_byte *) location;
 	recend = rec + count;
-	while (rec < recend)
-	  {
+        while (recend - rec >= 4)
+          {
+            size_t len = bfd_get_32 (abfd, rec);
+            if (len == 0 || len > (size_t) (recend - rec) / 4)
+              break;
+            rec += len * 4;
 	    ++section->lma;
-	    rec += bfd_get_32 (abfd, rec) * 4;
 	  }
 
 	BFD_ASSERT (rec == recend);
-- 
2.35.6

