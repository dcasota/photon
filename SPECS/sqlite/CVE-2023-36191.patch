From 8ea4a9fef4eb41b098d9e740fb88d92f782fdc44 Mon Sep 17 00:00:00 2001
From: Kuntal Nayak <nkuntal@vmware.com>
Date: Thu, 31 Aug 2023 17:27:05 +0000
Subject: [PATCH] Fix CLI seg fault on missing nonce

The upstream patch - https://sqlite.org/src/info/cd24178bbaad4a1d
is not directly applicable to the source that we are consuming because
source: https://www.sqlite.org/src/tarball/sqlite.tar.gz?r=release. Whilst
we are consuming: https://sqlite.org/2022/sqlite-autoconf-%{sourcever}.tar.gz. 

So the patch had to be adapted and file path is modified.

The bug is in command-line argument parsing. Due to improper command-line
argument processing a NULL-pointer dereference will occur and the
"sqlite3" tool will fail to start up.

Detailed CVE and fix info: https://www.sqlite.org/forum/forumpost/19f55ef73b

---
 shell.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/shell.c b/shell.c
index 63f708c..dfb234b 100644
--- a/shell.c
+++ b/shell.c
@@ -26107,8 +26107,12 @@ int SQLITE_CDECL wmain(int argc, wchar_t **wargv){
     }else if( cli_strcmp(z,"-bail")==0 ){
       bail_on_error = 1;
     }else if( cli_strcmp(z,"-nonce")==0 ){
-      free(data.zNonce);
-      data.zNonce = strdup(argv[++i]);
+      if( data.zNonce ) free(data.zNonce);
+      if( i+1 < argc ) data.zNonce = strdup(argv[++i]);
+      else {
+         data.zNonce = 0;
+         break;
+      }
     }else if( cli_strcmp(z,"-safe")==0 ){
       /* no-op - catch this on the second pass */
     }
-- 
2.39.0

