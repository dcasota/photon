From 63cb3a8574632b4e2b9de7db560d50e1bacaac59 Mon Sep 17 00:00:00 2001
From: y5c4l3 <y5c4l3@proton.me>
Date: Wed, 25 Sep 2024 23:36:06 +0800
Subject: [PATCH] Quote template strings in activation script

This patch adds `quote` method in `ViaTemplateActivator` so that the
magic template strings can be quoted correctly when replacing. This
mitigates potential command injection (#2768).

Signed-off-by: y5c4l3 <y5c4l3@proton.me>

[prashant.singh-chauhan: Backported patch to 20.1.0]
Signed-off-by: Prashant S Chauhan <prashant.singh-chauhan@broadcom.com>

Exploit:
https://github.com/pypa/virtualenv/issues/2768
root [ /';uname -a;': ]# . ./bin/activate
Linux dcf7cd7a303d 6.1.10-10.ph5-esx #1-photon SMP Mon Apr 24 22:51:08 UTC 2023 x86_64 GNU/Linux
(/) root [ /';uname -a;': ]#

After fix:
root [ /';uname -a;': ]# . ./bin/activate
(';uname -a;':) root [ /';uname -a;': ]# 

---
 pyproject.toml                                |  3
 src/virtualenv/activation/bash/activate.sh    |  8 +++----
 src/virtualenv/activation/batch/__init__.py   |  4 ++++
 src/virtualenv/activation/cshell/activate.csh |  8 +++----
 src/virtualenv/activation/fish/activate.fish  |  8 +++----
 src/virtualenv/activation/nushell/__init__.py | 19 +++++++++++++++++
 src/virtualenv/activation/nushell/activate.nu |  8 +++----
 .../activation/powershell/__init__.py         | 12 +++++++++++
 .../activation/powershell/activate.ps1        |  6 +++---
 src/virtualenv/activation/python/__init__.py  |  6 +++++-
 .../activation/python/activate_this.py        |  8 +++----
 src/virtualenv/activation/via_template.py     | 13 +++++++++++-
 tests/conftest.py                             |  6 +++++-
 tests/unit/activation/conftest.py             |  3 +--
 tests/unit/activation/test_batch.py           | 10 ++++-----
 tests/unit/activation/test_powershell.py      | 21 +++++++++++++------
 17 files changed, 106 insertions(+), 39 deletions(-)
 create mode 100644 docs/changelog/2768.bugfix.rst

diff --git a/pyproject.toml b/pyproject.toml
index c2b3b9a..fc2bf75 100644
--- a/pyproject.toml
+++ b/pyproject.toml
@@ -17,3 +17,7 @@ directory = "docs/changelog"
 title_format = false
 issue_format = "`#{issue} <https://github.com/pypa/virtualenv/issues/{issue}>`_"
 template = "docs/changelog/template.jinja2"
+
+lint.per-file-ignores."src/virtualenv/activation/python/activate_this.py" = [
+  "F821", # ignore undefined template string placeholders
+]
diff --git a/src/virtualenv/activation/bash/activate.sh b/src/virtualenv/activation/bash/activate.sh
index 222d982..1a22a35 100644
--- a/src/virtualenv/activation/bash/activate.sh
+++ b/src/virtualenv/activation/bash/activate.sh
@@ -46,14 +46,14 @@ deactivate () {
 # unset irrelevant variables
 deactivate nondestructive
 
-VIRTUAL_ENV='__VIRTUAL_ENV__'
+VIRTUAL_ENV=__VIRTUAL_ENV__
 if ([ "$OSTYPE" = "cygwin" ] || [ "$OSTYPE" = "msys" ]) && $(command -v cygpath &> /dev/null) ; then
     VIRTUAL_ENV=$(cygpath -u "$VIRTUAL_ENV")
 fi
 export VIRTUAL_ENV
 
 _OLD_VIRTUAL_PATH="$PATH"
-PATH="$VIRTUAL_ENV/__BIN_NAME__:$PATH"
+PATH="$VIRTUAL_ENV/"__BIN_NAME__":$PATH"
 export PATH
 
 # unset PYTHONHOME if set
@@ -64,8 +64,8 @@ fi
 
 if [ -z "${VIRTUAL_ENV_DISABLE_PROMPT-}" ] ; then
     _OLD_VIRTUAL_PS1="${PS1-}"
-    if [ "x__VIRTUAL_PROMPT__" != x ] ; then
-        PS1="__VIRTUAL_PROMPT__${PS1-}"
+    if [ "x"__VIRTUAL_PROMPT__ != x ] ; then
+        PS1=__VIRTUAL_PROMPT__"${PS1-}"
     else
         PS1="(`basename \"$VIRTUAL_ENV\"`) ${PS1-}"
     fi
diff --git a/src/virtualenv/activation/batch/__init__.py b/src/virtualenv/activation/batch/__init__.py
index 4149712..4137405 100644
--- a/src/virtualenv/activation/batch/__init__.py
+++ b/src/virtualenv/activation/batch/__init__.py
@@ -17,6 +17,10 @@ class BatchActivator(ViaTemplateActivator):
         yield Path("deactivate.bat")
         yield Path("pydoc.bat")
 
+    @staticmethod
+    def quote(string):
+        return string
+
     def instantiate_template(self, replacements, template, creator):
         # ensure the text has all newlines as \r\n - required by batch
         base = super(BatchActivator, self).instantiate_template(replacements, template, creator)
diff --git a/src/virtualenv/activation/cshell/activate.csh b/src/virtualenv/activation/cshell/activate.csh
index 72b2cf8..8c73601 100644
--- a/src/virtualenv/activation/cshell/activate.csh
+++ b/src/virtualenv/activation/cshell/activate.csh
@@ -10,15 +10,15 @@ alias deactivate 'test $?_OLD_VIRTUAL_PATH != 0 && setenv PATH "$_OLD_VIRTUAL_PA
 # Unset irrelevant variables.
 deactivate nondestructive
 
-setenv VIRTUAL_ENV '__VIRTUAL_ENV__'
+setenv VIRTUAL_ENV __VIRTUAL_ENV__
 
 set _OLD_VIRTUAL_PATH="$PATH:q"
-setenv PATH "$VIRTUAL_ENV:q/__BIN_NAME__:$PATH:q"
+setenv PATH "$VIRTUAL_ENV:q/"__BIN_NAME__":$PATH:q"
 
 
 
-if ('__VIRTUAL_PROMPT__' != "") then
-    set env_name = '__VIRTUAL_PROMPT__'
+if (__VIRTUAL_PROMPT__ != "") then
+    set env_name = __VIRTUAL_PROMPT__
 else
     set env_name = '('"$VIRTUAL_ENV:t:q"') '
 endif
diff --git a/src/virtualenv/activation/fish/activate.fish b/src/virtualenv/activation/fish/activate.fish
index faa2622..d6390d2 100644
--- a/src/virtualenv/activation/fish/activate.fish
+++ b/src/virtualenv/activation/fish/activate.fish
@@ -57,7 +57,7 @@ end
 # Unset irrelevant variables.
 deactivate nondestructive
 
-set -gx VIRTUAL_ENV '__VIRTUAL_ENV__'
+set -gx VIRTUAL_ENV __VIRTUAL_ENV__
 
 # https://github.com/fish-shell/fish-shell/issues/436 altered PATH handling
 if test (echo $FISH_VERSION | head -c 1) -lt 3
@@ -65,7 +65,7 @@ if test (echo $FISH_VERSION | head -c 1) -lt 3
 else
     set -gx _OLD_VIRTUAL_PATH "$PATH"
 end
-set -gx PATH "$VIRTUAL_ENV"'/__BIN_NAME__' $PATH
+set -gx PATH "$VIRTUAL_ENV"'/'__BIN_NAME__ $PATH
 
 # Unset `$PYTHONHOME` if set.
 if set -q PYTHONHOME
@@ -87,8 +87,8 @@ if test -z "$VIRTUAL_ENV_DISABLE_PROMPT"
 
         # Prompt override provided?
         # If not, just prepend the environment name.
-        if test -n '__VIRTUAL_PROMPT__'
-            printf '%s%s' '__VIRTUAL_PROMPT__' (set_color normal)
+        if test -n __VIRTUAL_PROMPT__
+            printf '%s%s' __VIRTUAL_PROMPT__ (set_color normal)
         else
             printf '%s(%s) ' (set_color normal) (basename "$VIRTUAL_ENV")
         end
diff --git a/src/virtualenv/activation/powershell/__init__.py b/src/virtualenv/activation/powershell/__init__.py
index 4fadc63..d570102 100644
--- a/src/virtualenv/activation/powershell/__init__.py
+++ b/src/virtualenv/activation/powershell/__init__.py
@@ -8,3 +8,14 @@ from ..via_template import ViaTemplateActivator
 class PowerShellActivator(ViaTemplateActivator):
     def templates(self):
         yield Path("activate.ps1")
+
+    @staticmethod
+    def quote(string):
+        """
+        This should satisfy PowerShell quoting rules [1], unless the quoted
+        string is passed directly to Windows native commands [2].
+        [1]: https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_quoting_rules
+        [2]: https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_parsing#passing-arguments-that-contain-quote-characters
+        """  # noqa: D205
+        string = string.replace("'", "''")
+        return f"'{string}'"
diff --git a/src/virtualenv/activation/powershell/activate.ps1 b/src/virtualenv/activation/powershell/activate.ps1
index a370a63..7b0891d 100644
--- a/src/virtualenv/activation/powershell/activate.ps1
+++ b/src/virtualenv/activation/powershell/activate.ps1
@@ -35,18 +35,18 @@ $env:VIRTUAL_ENV = $VIRTUAL_ENV
 
 New-Variable -Scope global -Name _OLD_VIRTUAL_PATH -Value $env:PATH
 
-$env:PATH = "$env:VIRTUAL_ENV/__BIN_NAME____PATH_SEP__" + $env:PATH
+$env:PATH = "$env:VIRTUAL_ENV/" + __BIN_NAME__ + __PATH_SEP__ + $env:PATH
 if (!$env:VIRTUAL_ENV_DISABLE_PROMPT) {
     function global:_old_virtual_prompt {
         ""
     }
     $function:_old_virtual_prompt = $function:prompt
 
-    if ("__VIRTUAL_PROMPT__" -ne "") {
+    if (__VIRTUAL_PROMPT__ -ne "") {
         function global:prompt {
             # Add the custom prefix to the existing prompt
             $previous_prompt_value = & $function:_old_virtual_prompt
-            ("__VIRTUAL_PROMPT__" + $previous_prompt_value)
+            (__VIRTUAL_PROMPT__ + $previous_prompt_value)
         }
     }
     else {
diff --git a/src/virtualenv/activation/python/__init__.py b/src/virtualenv/activation/python/__init__.py
index 9e57912..e023770 100644
--- a/src/virtualenv/activation/python/__init__.py
+++ b/src/virtualenv/activation/python/__init__.py
@@ -14,6 +14,10 @@ class PythonActivator(ViaTemplateActivator):
     def templates(self):
         yield Path("activate_this.py")
 
+    @staticmethod
+    def quote(string):
+        return repr(string)
+
     def replacements(self, creator, dest_folder):
         replacements = super(PythonActivator, self).replacements(creator, dest_folder)
         lib_folders = OrderedDict((os.path.relpath(str(i), str(dest_folder)), None) for i in creator.libs)
diff --git a/src/virtualenv/activation/python/activate_this.py b/src/virtualenv/activation/python/activate_this.py
index 29debe3..45cf024 100644
--- a/src/virtualenv/activation/python/activate_this.py
+++ b/src/virtualenv/activation/python/activate_this.py
@@ -15,7 +15,7 @@ except NameError:
     raise AssertionError("You must use exec(open(this_file).read(), {'__file__': this_file}))")
 
 bin_dir = os.path.dirname(abs_file)
-base = bin_dir[: -len("__BIN_NAME__") - 1]  # strip away the bin part from the __file__, plus the path separator
+base = bin_dir[: -len(__BIN_NAME__) - 1]  # strip away the bin part from the __file__, plus the path separator
 
 # prepend bin to PATH (this file is inside the bin directory)
 os.environ["PATH"] = os.pathsep.join([bin_dir] + os.environ.get("PATH", "").split(os.pathsep))
@@ -23,9 +23,9 @@ os.environ["VIRTUAL_ENV"] = base  # virtual env is right above bin directory
 
 # add the virtual environments libraries to the host python import mechanism
 prev_length = len(sys.path)
-for lib in "__LIB_FOLDERS__".split(os.pathsep):
+for lib in __LIB_FOLDERS__.split(os.pathsep):
     path = os.path.realpath(os.path.join(bin_dir, lib))
-    site.addsitedir(path.decode("utf-8") if "__DECODE_PATH__" else path)
+    site.addsitedir(path.decode("utf-8") if __DECODE_PATH__ else path)
 sys.path[:] = sys.path[prev_length:] + sys.path[0:prev_length]
 
 sys.real_prefix = sys.prefix
diff --git a/src/virtualenv/activation/via_template.py b/src/virtualenv/activation/via_template.py
index 14f0979..2e87360 100644
--- a/src/virtualenv/activation/via_template.py
+++ b/src/virtualenv/activation/via_template.py
@@ -1,6 +1,7 @@
 from __future__ import absolute_import, unicode_literals
 
 import os
+import shlex
 import sys
 from abc import ABCMeta, abstractmethod
 
@@ -22,6 +23,15 @@ class ViaTemplateActivator(Activator):
     def templates(self):
         raise NotImplementedError
 
+    @staticmethod
+    def quote(string):
+        """
+        Quote strings in the activation script.
+        :param string: the string to quote
+        :return: quoted string that works in the activation script
+        """
+        return shlex.quote(string)
+
     def generate(self, creator):
         dest_folder = creator.bin_dir
         replacements = self.replacements(creator, dest_folder)
@@ -58,7 +68,7 @@ class ViaTemplateActivator(Activator):
         text = binary.decode("utf-8", errors="strict")
         for key, value in replacements.items():
             value = self._repr_unicode(creator, value)
-            text = text.replace(key, value)
+            text = text.replace(key, self.quote(value))
         return text
 
     @staticmethod
diff --git a/tests/conftest.py b/tests/conftest.py
index 3fa0bba..9970414 100644
--- a/tests/conftest.py
+++ b/tests/conftest.py
@@ -267,7 +267,11 @@ def is_inside_ci():
 
 @pytest.fixture(scope="session")
 def special_char_name():
-    base = "e-$ èрт🚒♞中片-j"
+    base = "'\";&&e-$ èрт🚒♞中片-j"
+    if IS_WIN:
+        # get rid of invalid characters on Windows
+        base = base.replace('"', "")
+        base = base.replace(";", "")
     # workaround for pypy3 https://bitbucket.org/pypy/pypy/issues/3147/venv-non-ascii-support-windows
     encoding = "ascii" if IS_PYPY and IS_WIN else sys.getfilesystemencoding()
     # let's not include characters that the file system cannot encode)
diff --git a/tests/unit/activation/conftest.py b/tests/unit/activation/conftest.py
index 5aa78bb..f2fc744 100644
--- a/tests/unit/activation/conftest.py
+++ b/tests/unit/activation/conftest.py
@@ -1,7 +1,6 @@
 from __future__ import absolute_import, unicode_literals
 
 import os
-import pipes
 import re
 import shutil
 import subprocess
@@ -151,7 +150,7 @@ class ActivationTester(object):
         assert out[-1] == "None", raw
 
     def quote(self, s):
-        return pipes.quote(s)
+        return self.of_class.quote(s)
 
     def python_cmd(self, cmd):
         return "{} -c {}".format(os.path.basename(sys.executable), self.quote(cmd))
diff --git a/tests/unit/activation/test_batch.py b/tests/unit/activation/test_batch.py
index e10d902..04de275 100644
--- a/tests/unit/activation/test_batch.py
+++ b/tests/unit/activation/test_batch.py
@@ -1,7 +1,5 @@
 from __future__ import absolute_import, unicode_literals
 
-import pipes
-
 from virtualenv.activation import BatchActivator
 
 
@@ -25,6 +23,9 @@ def test_batch(activation_tester_class, activation_tester, tmp_path, activation_
 
         def quote(self, s):
             """double quotes needs to be single, and single need to be double"""
-            return "".join(("'" if c == '"' else ('"' if c == "'" else c)) for c in pipes.quote(s))
+            if '"' in s or " " in s:
+                text = s.replace('"', r"\"")
+                return f'"{text}"'
+            return s
 
     activation_tester(Batch)
diff --git a/tests/unit/activation/test_powershell.py b/tests/unit/activation/test_powershell.py
index b2d4cda..3b309f9 100644
--- a/tests/unit/activation/test_powershell.py
+++ b/tests/unit/activation/test_powershell.py
@@ -1,6 +1,5 @@
 from __future__ import absolute_import, unicode_literals
 
-import pipes
 import sys
 
 import pytest
@@ -19,10 +18,6 @@ def test_powershell(activation_tester_class, activation_tester):
             self.activate_cmd = "."
             self.script_encoding = "utf-16"
 
-        def quote(self, s):
-            """powershell double double quote needed for quotes within single quotes"""
-            return pipes.quote(s).replace('"', '""')
-
         def _get_test_lines(self, activate_script):
             # for BATCH utf-8 support need change the character code page to 650001
             return super(PowerShell, self)._get_test_lines(activate_script)
@@ -30,4 +25,19 @@ def test_powershell(activation_tester_class, activation_tester):
         def invoke_script(self):
             return [self.cmd, "-File"]
 
+        def quote(self, s):
+            """
+            Tester will pass strings to native commands on Windows so extra
+            parsing rules are used. Check `PowerShellActivator.quote` for more
+            details.
+            """
+            text = PowerShellActivator.quote(s)
+            return text.replace('"', '""') if sys.platform == "win32" else text
+
+        def activate_call(self, script):
+            # Commands are called without quotes in PowerShell
+            cmd = self.activate_cmd
+            scr = self.quote(str(script))
+            return f"{cmd} {scr}".strip()
+
     activation_tester(PowerShell)
