From 4c6fe2e2ea62469642ed1d80b16d39e616b25cf5 Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Sat, 2 Sep 2023 19:30:03 +0200
Subject: [PATCH] patch 9.0.1846: [security] crash in fullcommand

Problem:  crash in fullcommand
Solution: Check for typeval correctly

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/ex_docmd.c                 | 2 +-
 src/testdir/test_functions.vim | 5 +++++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --color -Naur a/src/ex_docmd.c b/src/ex_docmd.c
--- a/src/ex_docmd.c	2022-06-28 00:45:10
+++ b/src/ex_docmd.c	2023-09-06 13:28:53
@@ -4041,7 +4041,7 @@
     if (in_vim9script() && check_for_string_arg(argvars, 0) == FAIL)
 	return;
 
-    name = argvars[0].vval.v_string;
+    name = tv_get_string(&argvars[0]);
     if (name == NULL)
 	return;
 
diff --color -Naur a/src/testdir/test_functions.vim b/src/testdir/test_functions.vim
--- a/src/testdir/test_functions.vim	2022-06-28 00:45:10
+++ b/src/testdir/test_functions.vim	2023-09-06 13:29:50
@@ -2962,4 +2962,9 @@
   bwipe!
 endfunc
 
+func Test_fullcommand()
+  " this used to crash vim
+  call assert_equal('', fullcommand(10))
+endfunc
+
 " vim: shiftwidth=2 sts=2 expandtab

