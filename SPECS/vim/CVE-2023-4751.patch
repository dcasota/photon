From e1121b139480f53d1b06f84f3e4574048108fa0b Mon Sep 17 00:00:00 2001
From: Pavel Mayorov <pmayorov@cloudlinux.com>
Date: Mon, 20 Feb 2023 14:35:20 +0000
Subject: [PATCH] patch 9.0.1331: illegal memory access when using :ball in
 Visual mode

Problem:    Illegal memory access when using :ball in Visual mode.
Solution:   Stop Visual mode when using :ball. (Pavel Mayorov, closes #11923)
---
 src/buffer.c                |  4 ++++
 src/testdir/test_visual.vim | 21 +++++++++++++++++++++
 1 files changed, 25 insertions(+)
 
diff --color -Naur a/src/buffer.c b/src/buffer.c
--- a/src/buffer.c	2022-06-28 00:45:10
+++ b/src/buffer.c	2023-09-06 13:20:29
@@ -5305,6 +5305,10 @@
     else
 	all = TRUE;
 
+    // Stop Visual mode, the cursor and "VIsual" may very well be invalid after
+    // switching to another buffer.
+    reset_VIsual_and_resel();
+
     setpcmark();
 
 #ifdef FEAT_GUI
diff --color -Naur a/src/testdir/test_visual.vim b/src/testdir/test_visual.vim
--- a/src/testdir/test_visual.vim	2022-06-28 00:45:10
+++ b/src/testdir/test_visual.vim	2023-09-06 13:21:44
@@ -1469,5 +1469,24 @@
   bwipe!
 endfunc
 
+" Check fix for the heap-based buffer overflow bug found in the function
+" utfc_ptr2len and reported at
+" https://huntr.dev/bounties/ae933869-a1ec-402a-bbea-d51764c6618e
+func Test_heap_buffer_overflow()
+  enew
+  set updatecount=0
+
+  norm R0
+  split other
+  norm R000
+  exe "norm \<C-V>l"
+  ball
+  call assert_equal(getpos("."), getpos("v"))
+  call assert_equal('n', mode())
+  norm zW
+
+  %bwipe!
+  set updatecount&
+endfunc
 
 " vim: shiftwidth=2 sts=2 expandtab

