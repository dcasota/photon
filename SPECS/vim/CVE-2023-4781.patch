From f6d28fe2c95c678cc3202cc5dc825a3fcc709e93 Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Tue, 5 Sep 2023 20:18:06 +0200
Subject: [PATCH] patch 9.0.1873: [security] heap-buffer-overflow in
 vim_regsub_both

Problem:  heap-buffer-overflow in vim_regsub_both
Solution: Disallow exchanging windows when textlock is active

Signed-off-by: Christian Brabandt <cb@256bit.org>
[ssrish:
         - resolved a hunk failure
         - excluded the poc binary file provided in the upstream patch
         - poc binary: src/testdir/crash/vim_regsub_both_poc]
Signed-off-by: Srish Srinivasan <ssrish@vmware.com>
---
 src/ex_cmds.c              | 3 +++
 src/testdir/test_crash.vim | 8 ++++++++
 src/version.c              | 2 ++
 src/window.c               | 5 +++++
 4 files changed, 18 insertions(+)

diff --git a/src/ex_cmds.c b/src/ex_cmds.c
index 045cddf..edffce3 100644
--- a/src/ex_cmds.c
+++ b/src/ex_cmds.c
@@ -4461,6 +4461,9 @@ ex_substitute(exarg_T *eap)
 		{
 		    nmatch = curbuf->b_ml.ml_line_count - sub_firstlnum + 1;
 		    skip_match = TRUE;
+		    // safety check
+		    if (nmatch < 0)
+			goto skip;
 		}

 		// Need room for:
diff --git a/src/testdir/test_crash.vim b/src/testdir/test_crash.vim
index 27bf7b5..9a23c96 100644
--- a/src/testdir/test_crash.vim
+++ b/src/testdir/test_crash.vim
@@ -44,11 +44,19 @@ func Test_crash1()

   let file = 'crash/poc_tagfunc.vim'
   let args = printf(cmn_args, vim, file)
+  " using || because this poc causes vim to exit with exitstatus != 0
   call term_sendkeys(buf, args ..
     \ '  || echo "crash 5: [OK]" >> X_crash1_result.txt' .. "\<cr>")

   call TermWait(buf, 100)

+  let file = 'crash/vim_regsub_both_poc'
+  let args = printf(cmn_args, vim, file)
+  " using || because this poc causes vim to exit with exitstatus != 0
+  call term_sendkeys(buf, args ..
+    \ '  && echo "crash 7: [OK]" >> X_crash1_result.txt' .. "\<cr>")
+  call TermWait(buf, 1000)
+
   " clean up
   exe buf .. "bw!"

diff --git a/src/version.c b/src/version.c
index bf5426b..aad243a 100644
--- a/src/version.c
+++ b/src/version.c
@@ -735,6 +735,8 @@ static char *(features[]) =

 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    1873,
 /**/
     1858,
 /**/
diff --git a/src/window.c b/src/window.c
index a750105..4f38840 100644
--- a/src/window.c
+++ b/src/window.c
@@ -1738,6 +1738,11 @@ win_rotate(int upwards, int count)
 	beep_flush();
 	return;
     }
+    if (text_or_buf_locked())
+    {
+	beep_flush();
+	return;
+    }

 #ifdef FEAT_GUI
     need_mouse_correct = TRUE;
--
2.35.6
