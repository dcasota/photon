From 2caf423bb29b0c8695f2e6242c4acd16089b0005 Mon Sep 17 00:00:00 2001
From: Frode Nordahl <frode.nordahl@canonical.com>
Date: Thu, 8 Feb 2024 09:48:12 +0100
Subject: [PATCH ovn branch-23.09] controller: Set check_tnl_key for BFD on
 tunnel ifaces.

The OVS BFD configuration option `check_tnl_key` controls whether
OVS should consider the tunnel key before processing BFD control
messages.  The OVN pipeline design ensures traffic originating
from a logical port will have a non-zero tunnel key.

Always set `check_tnl_key` to "true" to avoid processing of
BFD control messages originating from a logical port.

Signed-off-by: Frode Nordahl <frode.nordahl@canonical.com>
Signed-off-by: Dumitru Ceara <dceara@redhat.com>

[anmolja: resolved hunk failures caused by line numbers]
Signed-off-by: Anmol Jain <anmol.jain@broadcom.com>

---
 ovn/controller/bfd.c |  3 +++
 1 file changed, 3 insertions(+)

diff --git a/ovn/controller/bfd.c b/ovn/controller/bfd.c
index 22db00a..9f08e10 100644
--- a/ovn/controller/bfd.c
+++ b/ovn/controller/bfd.c
@@ -232,6 +232,9 @@ bfd_run(const struct ovsrec_interface_table *interface_table,
         if (mult) {
             smap_add(&bfd, "mult", mult);
         }
+        /* `check_tnl_key` must always be set to "true" to avoid processing of
+         * BFD control messages originating from a logical port. */
+        smap_add(&bfd, "check_tnl_key", "true");
     }

     /* Enable or disable bfd */
--
2.35.6