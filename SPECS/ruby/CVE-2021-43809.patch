From a4f2f8ac17e6ce81c689527a8b6f14381060d95f Mon Sep 17 00:00:00 2001
From: Simon Fish <si@mon.fish>
Date: Tue, 26 Oct 2021 17:50:55 +0100
Subject: [PATCH] Add require parameter to `bundle add``

Test and ensure "false" is handled

Don't use yield_self to operate on autorequire

Remove duplicate autorequire

Add banner to require option

Don't use json to break down require params

Pass linter

[Backport to ruby 2.7.4, https://github.com/rubygems/rubygems/commit/a4f2f8ac17e6ce81c689527a8b6f14381060d95f]
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
---
 lib/bundler/cli.rb                |  1 +
 lib/bundler/injector.rb           |  9 ++++++++-
 spec/bundler/commands/add_spec.rb | 12 ++++++++++++
 3 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/lib/bundler/cli.rb b/lib/bundler/cli.rb
index 443458f..84c06da 100644
--- a/lib/bundler/cli.rb
+++ b/lib/bundler/cli.rb
@@ -387,6 +387,7 @@ module Bundler
     method_option "version", :aliases => "-v", :type => :string
     method_option "group", :aliases => "-g", :type => :string
     method_option "source", :aliases => "-s", :type => :string
+    method_option "require", :aliases => "-r", :type => :string, :banner => "Adds require path to gem. Provide false, or a path as a string."
     method_option "git", :type => :string
     method_option "branch", :type => :string
     method_option "skip-install", :type => :boolean, :banner =>
diff --git a/lib/bundler/injector.rb b/lib/bundler/injector.rb
index 2cdda57..57f6cd3 100644
--- a/lib/bundler/injector.rb
+++ b/lib/bundler/injector.rb
@@ -113,8 +113,9 @@ module Bundler
         source = ", :source => \"#{d.source}\"" unless d.source.nil?
         git = ", :git => \"#{d.git}\"" unless d.git.nil?
         branch = ", :branch => \"#{d.branch}\"" unless d.branch.nil?
+        require_path = ", :require => #{convert_autorequire(d.autorequire)}" unless d.autorequire.nil?
 
-        %(gem #{name}#{requirement}#{group}#{source}#{git}#{branch})
+        %(gem #{name}#{requirement}#{group}#{source}#{git}#{branch}#{require_path})
       end.join("\n")
     end
 
@@ -251,5 +252,11 @@ module Bundler
     def show_warning(message)
       Bundler.ui.info Bundler.ui.add_color(message, :yellow)
     end
+
+    def convert_autorequire(autorequire)
+      autorequire = autorequire.first
+      return autorequire if autorequire == "false"
+      autorequire.inspect
+    end
   end
 end
diff --git a/spec/bundler/commands/add_spec.rb b/spec/bundler/commands/add_spec.rb
index 35fd43d..b193827 100644
--- a/spec/bundler/commands/add_spec.rb
+++ b/spec/bundler/commands/add_spec.rb
@@ -68,6 +68,18 @@ RSpec.describe "bundle add" do
     end
   end
 
+  describe "with --require" do
+    it "adds the require param for the gem" do
+      bundle "add 'foo' --require=foo/engine"
+      expect(bundled_app_gemfile.read).to match(%r{gem "foo",(?: .*,) :require => "foo\/engine"})
+    end
+
+    it "converts false to a boolean" do
+      bundle "add 'foo' --require=false"
+      expect(bundled_app_gemfile.read).to match(/gem "foo",(?: .*,) :require => false/)
+    end
+  end
+
   describe "with --group" do
     it "adds dependency for the specified group" do
       bundle "add 'foo' --group='development'"
-- 
2.39.4

