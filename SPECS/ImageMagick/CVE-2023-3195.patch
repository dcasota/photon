From f620340935777b28fa3f7b0ed7ed6bd86946934c Mon Sep 17 00:00:00 2001
From: Cristy <mikayla-grace@urban-warrior.org>
Date: Tue, 19 Oct 2021 14:53:54 -0400
Subject: [PATCH] fix stack overflow when parsing malicious tiff image

[ Upstream commit f620340935777b28fa3f7b0ed7ed6bd86946934c ]

Signed-off-by: Cristy <mikayla-grace@urban-warrior.org>
Signed-off-by: Ashwin Dayanand Kamat <ashwin.kamat@broadcom.com>
[Handled hunk failures]
---
 coders/tiff.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/coders/tiff.c b/coders/tiff.c
index e37a35b..c8775e8 100644
--- a/coders/tiff.c
+++ b/coders/tiff.c
@@ -2011,6 +2011,11 @@ static Image *ReadTIFFImage(const ImageInfo *image_info,
           ThrowTIFFException(ResourceLimitError,"MemoryAllocationFailed");
         extent=4*(samples_per_pixel+1)*MagickMax((rows+1)*TIFFTileRowSize(tiff),
           TIFFTileSize(tiff));
+#if defined(TIFF_VERSION_BIG)
+        extent+=image->columns*sizeof(uint64);
+#else
+        extent+=image->columns*sizeof(uint32);
+#endif
         tile_pixels=(unsigned char *) AcquireQuantumMemory(extent,
           sizeof(*tile_pixels));
         if (tile_pixels == (unsigned char *) NULL)
-- 
2.35.6

